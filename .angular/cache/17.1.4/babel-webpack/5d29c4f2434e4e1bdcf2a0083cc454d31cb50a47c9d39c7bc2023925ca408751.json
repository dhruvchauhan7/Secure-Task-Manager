{"ast":null,"code":"import { HttpClient } from '@angular/common/http';\nimport { BehaviorSubject, map, tap } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class AuthService {\n  constructor(http) {\n    this.http = http;\n    this.STORAGE_KEY = 'stm_access_token';\n    this.currentUserSubject = new BehaviorSubject(null);\n    this.currentUser$ = this.currentUserSubject.asObservable();\n    const token = this.getToken();\n    if (token) {\n      const user = this.decodeToken(token);\n      if (user && !this.isExpired(user)) {\n        this.currentUserSubject.next(user);\n      } else {\n        this.clearToken();\n      }\n    }\n  }\n  login(email, password) {\n    return this.http.post('http://localhost:3000/api/auth/login', {\n      email,\n      password\n    }).pipe(tap(res => {\n      this.setToken(res.accessToken);\n    }), map(res => {\n      const user = this.decodeToken(res.accessToken);\n      if (!user) {\n        throw new Error('Failed to decode token');\n      }\n      this.currentUserSubject.next(user);\n      return user;\n    }));\n  }\n  logout() {\n    this.clearToken();\n    this.currentUserSubject.next(null);\n  }\n  getToken() {\n    return localStorage.getItem(this.STORAGE_KEY);\n  }\n  setToken(token) {\n    localStorage.setItem(this.STORAGE_KEY, token);\n  }\n  clearToken() {\n    localStorage.removeItem(this.STORAGE_KEY);\n  }\n  decodeToken(token) {\n    try {\n      const [, payload] = token.split('.');\n      const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));\n      return JSON.parse(json);\n    } catch {\n      return null;\n    }\n  }\n  isExpired(user) {\n    if (!user.exp) return false;\n    const nowSeconds = Math.floor(Date.now() / 1000);\n    return user.exp <= nowSeconds;\n  }\n  isLoggedIn() {\n    const user = this.currentUserSubject.value;\n    return !!user && !this.isExpired(user);\n  }\n  hasRole(roles) {\n    const user = this.currentUserSubject.value;\n    if (!user) return false;\n    const list = Array.isArray(roles) ? roles : [roles];\n    return list.includes(user.role);\n  }\n  static {\n    this.ɵfac = function AuthService_Factory(t) {\n      return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: AuthService,\n      factory: AuthService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["HttpClient","BehaviorSubject","map","tap","AuthService","constructor","http","STORAGE_KEY","currentUserSubject","currentUser$","asObservable","token","getToken","user","decodeToken","isExpired","next","clearToken","login","email","password","post","pipe","res","setToken","accessToken","Error","logout","localStorage","getItem","setItem","removeItem","payload","split","json","atob","replace","JSON","parse","exp","nowSeconds","Math","floor","Date","now","isLoggedIn","value","hasRole","roles","list","Array","isArray","includes","role","i0","ɵɵinject","i1","factory","ɵfac","providedIn"],"sources":["E:\\Practice\\secure-task-manager\\apps\\dashboard\\src\\app\\auth\\auth.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { BehaviorSubject, Observable, map, tap } from 'rxjs';\r\nimport { AuthUser, UserRole } from './auth.models';\r\n\r\ninterface LoginResponse {\r\n  accessToken: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class AuthService {\r\n  private readonly STORAGE_KEY = 'stm_access_token';\r\n\r\n  private currentUserSubject = new BehaviorSubject<AuthUser | null>(null);\r\n  currentUser$ = this.currentUserSubject.asObservable();\r\n\r\n  constructor(private http: HttpClient) {\r\n    const token = this.getToken();\r\n    if (token) {\r\n      const user = this.decodeToken(token);\r\n      if (user && !this.isExpired(user)) {\r\n        this.currentUserSubject.next(user);\r\n      } else {\r\n        this.clearToken();\r\n      }\r\n    }\r\n  }\r\n\r\n  login(email: string, password: string): Observable<AuthUser> {\r\n    return this.http\r\n      .post<LoginResponse>('http://localhost:3000/api/auth/login', {\r\n        email,\r\n        password,\r\n      })\r\n      .pipe(\r\n        tap((res) => {\r\n          this.setToken(res.accessToken);\r\n        }),\r\n        map((res) => {\r\n          const user = this.decodeToken(res.accessToken);\r\n          if (!user) {\r\n            throw new Error('Failed to decode token');\r\n          }\r\n          this.currentUserSubject.next(user);\r\n          return user;\r\n        }),\r\n      );\r\n  }\r\n\r\n  logout() {\r\n    this.clearToken();\r\n    this.currentUserSubject.next(null);\r\n  }\r\n\r\n  getToken(): string | null {\r\n    return localStorage.getItem(this.STORAGE_KEY);\r\n  }\r\n\r\n  private setToken(token: string) {\r\n    localStorage.setItem(this.STORAGE_KEY, token);\r\n  }\r\n\r\n  private clearToken() {\r\n    localStorage.removeItem(this.STORAGE_KEY);\r\n  }\r\n\r\n  private decodeToken(token: string): AuthUser | null {\r\n    try {\r\n      const [, payload] = token.split('.');\r\n      const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));\r\n      return JSON.parse(json) as AuthUser;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private isExpired(user: AuthUser): boolean {\r\n    if (!user.exp) return false;\r\n    const nowSeconds = Math.floor(Date.now() / 1000);\r\n    return user.exp <= nowSeconds;\r\n  }\r\n\r\n  isLoggedIn(): boolean {\r\n    const user = this.currentUserSubject.value;\r\n    return !!user && !this.isExpired(user);\r\n  }\r\n\r\n  hasRole(roles: UserRole | UserRole[]): boolean {\r\n    const user = this.currentUserSubject.value;\r\n    if (!user) return false;\r\n    const list = Array.isArray(roles) ? roles : [roles];\r\n    return list.includes(user.role);\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}